#!/bin/bash
#
# Pre-commit hook for SwiftStaticAnalysis
# Run: ./scripts/install-hooks.sh to install
#
# Checks:
# 1. Format (auto-fix)
# 2. Format check (verify)
# 3. Version consistency
# 4. Build
# 5. Tests
# 6. Unused code detection
# 7. Duplicates detection
#

set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Find project root (where .git is)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
SCRIPTS_DIR="$PROJECT_ROOT/scripts"
cd "$PROJECT_ROOT"

# 1. Format (auto-fix)
echo -e "\n${YELLOW}[1/7] Formatting code...${NC}"
swift format format --in-place --parallel --recursive Sources/
# Format test files (excluding fixtures - intentionally bad code for testing)
find Tests -type f -name "*.swift" -not -path "*/Fixtures/*" -print0 | xargs -0 swift format format --in-place --parallel
echo -e "${GREEN}Format applied${NC}"

# 2. Format check (verify)
echo -e "\n${YELLOW}[2/7] Checking format...${NC}"
if ! swift format lint --strict --parallel --recursive Sources/ 2>&1; then
    echo -e "${RED}Format check failed!${NC}"
    exit 1
fi
# Lint test files (excluding fixtures)
if ! find Tests -type f -name "*.swift" -not -path "*/Fixtures/*" -print0 | xargs -0 swift format lint --strict --parallel 2>&1; then
    echo -e "${RED}Test format check failed!${NC}"
    exit 1
fi
echo -e "${GREEN}Format check passed${NC}"

# 3. Version consistency check
echo -e "\n${YELLOW}[3/7] Checking version consistency...${NC}"
if ! "$SCRIPTS_DIR/check-version.sh" 2>&1; then
    echo -e "${RED}Version check failed!${NC}"
    exit 1
fi
echo -e "${GREEN}Version check passed${NC}"

# 4. Build
echo -e "\n${YELLOW}[4/7] Building...${NC}"
if ! swift build 2>&1 | tail -3; then
    echo -e "${RED}Build failed!${NC}"
    exit 1
fi
echo -e "${GREEN}Build passed${NC}"

# 5. Run tests
echo -e "\n${YELLOW}[5/7] Running tests...${NC}"
if ! swift test --parallel 2>&1 | tail -5; then
    echo -e "${RED}Tests failed!${NC}"
    exit 1
fi
echo -e "${GREEN}Tests passed${NC}"

# 6. Unused code detection
echo -e "\n${YELLOW}[6/7] Checking for unused code...${NC}"
UNUSED_OUTPUT=$(.build/debug/swa unused Sources/ --sensible-defaults --format xcode 2>&1 || true)
if [ -n "$UNUSED_OUTPUT" ]; then
    echo -e "${RED}Unused code found:${NC}"
    echo "$UNUSED_OUTPUT"
    echo -e "${RED}Please fix unused code issues before committing.${NC}"
    exit 1
fi
echo -e "${GREEN}No unused code found${NC}"

# 7. Duplicates detection (informational, non-blocking)
echo -e "\n${YELLOW}[7/7] Checking for code duplicates...${NC}"
DUPLICATES_COUNT=$(.build/debug/swa duplicates Sources/ --format xcode --min-tokens 50 2>&1 | wc -l | tr -d ' ')
if [ "$DUPLICATES_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}Found $DUPLICATES_COUNT duplicate code warnings (informational)${NC}"
else
    echo -e "${GREEN}No duplicates found${NC}"
fi

echo -e "\n${GREEN}All pre-commit checks passed!${NC}"
exit 0
