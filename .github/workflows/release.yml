name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0)'
        required: true
      create_tag:
        description: 'Create git tag'
        type: boolean
        default: false

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  validate:
    name: Validate
    runs-on: macos-15
    if: |
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/tags/v') ||
      (github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip release]') && !contains(github.event.head_commit.author.name, 'github-actions'))
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      previous_tag: ${{ steps.previous.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
            TAG="v${VERSION}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
          else
            # Auto-increment: get latest tag and bump patch version
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            LATEST_VERSION="${LATEST_TAG#v}"

            # Parse semver
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
            PATCH=$((PATCH + 1))
            VERSION="${MAJOR}.${MINOR}.${PATCH}"
            TAG="v${VERSION}"

            echo "Auto-incrementing from $LATEST_VERSION to $VERSION"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}, Tag: ${TAG}"

      - name: Get Previous Tag
        id: previous
        run: |
          PREVIOUS=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=${PREVIOUS}" >> $GITHUB_OUTPUT
          echo "Previous tag: ${PREVIOUS:-none}"

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.1.1.app

      - name: Build Release
        run: swift build -c release

      - name: Run Tests
        run: swift test --parallel

  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog
        id: changelog
        run: |
          PREVIOUS="${{ needs.validate.outputs.previous_tag }}"
          TAG="${{ needs.validate.outputs.tag }}"

          if [[ -n "$PREVIOUS" ]]; then
            RANGE="${PREVIOUS}..HEAD"
          else
            RANGE="HEAD"
          fi

          echo "Generating changelog for range: $RANGE"

          {
            echo "content<<CHANGELOG_EOF"

            # Features
            FEATURES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^feat" --grep="^add" --grep="^new" -i 2>/dev/null || echo "")
            if [[ -n "$FEATURES" ]]; then
              echo "### Features"
              echo "$FEATURES"
              echo ""
            fi

            # Bug Fixes
            FIXES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^fix" -i 2>/dev/null || echo "")
            if [[ -n "$FIXES" ]]; then
              echo "### Bug Fixes"
              echo "$FIXES"
              echo ""
            fi

            # Performance
            PERF=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^perf" --grep="performance" -i 2>/dev/null || echo "")
            if [[ -n "$PERF" ]]; then
              echo "### Performance"
              echo "$PERF"
              echo ""
            fi

            # Other changes
            OTHER=$(git log $RANGE --pretty=format:"- %s (%h)" --invert-grep --grep="^feat" --grep="^fix" --grep="^perf" --grep="^add" --grep="^new" -i 2>/dev/null | head -20 || echo "")
            if [[ -n "$OTHER" ]]; then
              echo "### Other Changes"
              echo "$OTHER"
              echo ""
            fi

            echo "CHANGELOG_EOF"
          } >> $GITHUB_OUTPUT

  create-release:
    name: Create Release
    runs-on: macos-15
    needs: [validate, changelog]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Tag
        if: |
          (github.event_name == 'workflow_dispatch' && inputs.create_tag) ||
          (github.event_name == 'push' && github.ref == 'refs/heads/main')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.validate.outputs.tag }}" -m "Release ${{ needs.validate.outputs.version }}"
          git push origin "${{ needs.validate.outputs.tag }}"

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.1.1.app

      - name: Build Universal Release Binary
        run: |
          # Build for arm64
          swift build -c release --arch arm64
          mv .build/release/swa .build/release/swa-arm64

          # Build for x86_64
          swift build -c release --arch x86_64
          mv .build/release/swa .build/release/swa-x86_64

          # Create universal binary
          lipo -create -output .build/release/swa \
            .build/release/swa-arm64 \
            .build/release/swa-x86_64

          # Verify universal binary
          file .build/release/swa
          lipo -info .build/release/swa

      - name: Package Binary
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p release

          # Copy and package universal binary
          cp .build/release/swa release/
          cd release
          tar -czvf "swa-${VERSION}-macos-universal.tar.gz" swa

          # Also package architecture-specific binaries
          cp ../.build/release/swa-arm64 ./swa
          tar -czvf "swa-${VERSION}-macos-arm64.tar.gz" swa
          cp ../.build/release/swa-x86_64 ./swa
          tar -czvf "swa-${VERSION}-macos-x86_64.tar.gz" swa

          # Restore universal for any other steps
          cp ../.build/release/swa ./swa

      - name: Generate Checksums
        run: |
          cd release
          shasum -a 256 *.tar.gz > checksums.txt
          cat checksums.txt

      - name: Generate Release Notes
        id: notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          {
            echo "notes<<NOTES_EOF"
            echo "## SwiftStaticAnalysis ${VERSION}"
            echo ""
            echo "### Installation"
            echo ""
            echo "#### Swift Package Manager"
            echo "\`\`\`swift"
            echo ".package(url: \"https://github.com/g-cqd/SwiftStaticAnalysis.git\", from: \"${VERSION}\")"
            echo "\`\`\`"
            echo ""
            echo "#### Pre-built Binary (macOS)"
            echo "\`\`\`bash"
            echo "# Universal binary (recommended - works on both Apple Silicon and Intel)"
            echo "curl -L https://github.com/g-cqd/SwiftStaticAnalysis/releases/download/v${VERSION}/swa-${VERSION}-macos-universal.tar.gz | tar xz"
            echo "sudo mv swa /usr/local/bin/"
            echo ""
            echo "# Or for Apple Silicon only"
            echo "curl -L https://github.com/g-cqd/SwiftStaticAnalysis/releases/download/v${VERSION}/swa-${VERSION}-macos-arm64.tar.gz | tar xz"
            echo ""
            echo "# Or for Intel only"
            echo "curl -L https://github.com/g-cqd/SwiftStaticAnalysis/releases/download/v${VERSION}/swa-${VERSION}-macos-x86_64.tar.gz | tar xz"
            echo "\`\`\`"
            echo ""
            echo "### Checksums"
            echo "\`\`\`"
            cat release/checksums.txt
            echo "\`\`\`"
            echo ""
            echo "### What's Changed"
            echo ""
            echo "${{ needs.changelog.outputs.changelog }}"
            echo ""
            echo "NOTES_EOF"
          } >> $GITHUB_OUTPUT

      - name: Determine Prerelease
        id: prerelease
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          if [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.tag }}
          name: ${{ needs.validate.outputs.version }}
          body: ${{ steps.notes.outputs.notes }}
          prerelease: ${{ steps.prerelease.outputs.is_prerelease }}
          files: |
            release/swa-${{ needs.validate.outputs.version }}-macos-universal.tar.gz
            release/swa-${{ needs.validate.outputs.version }}-macos-arm64.tar.gz
            release/swa-${{ needs.validate.outputs.version }}-macos-x86_64.tar.gz
            release/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
